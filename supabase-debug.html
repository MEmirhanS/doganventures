<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #111; color: #fff; }
        .test-container { max-width: 600px; margin: 0 auto; }
        .test-button { 
            background: #007acc; 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            margin: 10px; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px;
        }
        .test-button:hover { background: #005a9e; }
        .log { 
            background: #222; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            border-left: 4px solid #007acc;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .error { border-left-color: #ff4444; }
        .success { border-left-color: #44ff44; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🔧 Supabase Connection Test</h1>
        
        <button class="test-button" onclick="testEnvironment()">1. Test Environment Variables</button>
        <button class="test-button" onclick="testSupabaseClient()">2. Test Supabase Client</button>
        <button class="test-button" onclick="testConnection()">3. Test Database Connection</button>
        <button class="test-button" onclick="testInsert()">4. Test Data Insert</button>
        <button class="test-button" onclick="clearLogs()">Clear Logs</button>
        
        <div id="logs"></div>
    </div>

    <script type="module">
        // Import Supabase client
        import { supabase } from './src/lib/supabaseClient.js';
        
        window.supabaseTestClient = supabase;
        
        window.testEnvironment = function() {
            addLog("🔧 Testing Environment Variables...", "");
            
            const url = import.meta.env.VITE_SUPABASE_URL;
            const key = import.meta.env.VITE_SUPABASE_ANON_KEY;
            
            addLog(`URL: ${url ? '✅ Set' : '❌ Missing'}`, url ? "success" : "error");
            addLog(`Key: ${key ? '✅ Set' : '❌ Missing'}`, key ? "success" : "error");
            
            if (url && key) {
                addLog("✅ Environment variables OK", "success");
            } else {
                addLog("❌ Environment variables missing!", "error");
            }
        };
        
        window.testSupabaseClient = function() {
            addLog("🔧 Testing Supabase Client...", "");
            
            try {
                if (window.supabaseTestClient) {
                    addLog("✅ Supabase client imported successfully", "success");
                    addLog(`Client type: ${typeof window.supabaseTestClient}`, "");
                    
                    // Test if basic methods exist
                    if (window.supabaseTestClient.from) {
                        addLog("✅ .from() method available", "success");
                    } else {
                        addLog("❌ .from() method missing", "error");
                    }
                } else {
                    addLog("❌ Supabase client not imported", "error");
                }
            } catch (error) {
                addLog(`❌ Client test error: ${error.message}`, "error");
            }
        };
        
        window.testConnection = async function() {
            addLog("🔧 Testing Database Connection...", "");
            
            try {
                if (!window.supabaseTestClient) {
                    throw new Error("Supabase client not available");
                }
                
                const { data, error, count } = await window.supabaseTestClient
                    .from('leads')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    throw error;
                }
                
                addLog("✅ Database connection successful!", "success");
                addLog(`📊 Total leads in database: ${count}`, "success");
                
            } catch (error) {
                addLog(`❌ Connection test failed: ${error.message}`, "error");
                if (error.details) {
                    addLog(`Details: ${error.details}`, "error");
                }
                if (error.hint) {
                    addLog(`Hint: ${error.hint}`, "error");
                }
            }
        };
        
        window.testInsert = async function() {
            addLog("🔧 Testing Data Insert...", "");
            
            try {
                if (!window.supabaseTestClient) {
                    throw new Error("Supabase client not available");
                }
                
                const testPayload = {
                    full_name: "Test User " + Date.now(),
                    email: `test${Date.now()}@example.com`,
                    phone: "5551234567",
                    company_name: "Test Company",
                    sector: "Test Sector",
                    monthly_budget: "0-5000",
                    need_description: "Test insert from debug page",
                    services: ["Test Service"],
                    utm_source: "debug_test",
                    utm_medium: "manual_test",
                    utm_campaign: "supabase_test",
                    created_at: new Date().toISOString()
                };
                
                addLog("📝 Test payload prepared:", "");
                addLog(JSON.stringify(testPayload, null, 2), "");
                
                const { data, error } = await window.supabaseTestClient
                    .from('leads')
                    .insert([testPayload])
                    .select();
                
                if (error) {
                    throw error;
                }
                
                addLog("✅ Data insert successful!", "success");
                addLog(`Inserted data: ${JSON.stringify(data, null, 2)}`, "success");
                
            } catch (error) {
                addLog(`❌ Insert test failed: ${error.message}`, "error");
                if (error.details) {
                    addLog(`Details: ${error.details}`, "error");
                }
                if (error.hint) {
                    addLog(`Hint: ${error.hint}`, "error");
                }
                if (error.code) {
                    addLog(`Code: ${error.code}`, "error");
                }
            }
        };
        
        window.clearLogs = function() {
            document.getElementById('logs').innerHTML = '';
        };
        
        function addLog(message, type = "") {
            const logs = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(logDiv);
            logs.scrollTop = logs.scrollHeight;
        }
        
        // Auto-run environment test on load
        setTimeout(() => {
            addLog("🚀 Supabase Test Page Loaded", "success");
            testEnvironment();
        }, 500);
    </script>
</body>
</html>
